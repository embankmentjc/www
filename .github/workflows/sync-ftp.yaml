name: CI
on:
  push:
    branches:
      - dev
jobs:
  sync_ftp:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repo
      uses: actions/checkout@v2
      with:
        ref: ${{ github.head_ref }}
    - name: Fetch FTP branch
      run: |
        git fetch origin ftp
        git log -n1 --format=%h origin/ftp
        git log -n1 --format=%h HEAD
        git log -n1 --format=%h $GITHUB_REF
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - uses: actions/cache@v2
      name: Configure pip caching
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
    - name: Verify SFTP install
      run: |
        which sftp
    - name: Setup SSH Config
      env:
        FTP_HOST: ${{ secrets.FTP_HOST }}
        FTP_USER: ${{ secrets.FTP_USER }}
        SSH_PUBKEY: ${{ secrets.SSH_PUBKEY }}
        SSH_PRIVKEY: ${{ secrets.SSH_PRIVKEY }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
      run: |
        ./set_ssh_config.sh
        cat known_hosts >> ~/.ssh/known_hosts
        echo version | sftp "${SSH_HOST}"
        ./sync-ftp.py -n -b origin/ftp "$SSH_HOST:public_html"
        git push origin HEAD:ftp
